/*!
 * Blocks by Pixel & Tonic
 *
 * @package   Blocks
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2012, Pixel & Tonic, Inc.
 * @license   http://blockscms.com/license1.0.html Blocks License
 * @link      http://blockscms.com
 */
(function(c){var a=Blocks.Base.extend({tiers:null,windowWidth:null,trailCurveWidth:null,maxVisibleNodes:null,init:function(){this.tiers=[];this.onWindowResize();this.addListener(Blocks.$window,"resize","onWindowResize")},getMaxVisibleNodes:function(){var d=Math.floor((Blocks.$window.width()-a.minElementMargin)/(a.elementWidth+a.minElementMargin));if(d<1){d=1}return d},onWindowResize:function(){if(this.windowWidth!==(this.windowWidth=Blocks.$window.width())){this.trailCurveWidth=100*a.trailCurveRadius/this.windowWidth;if(this.maxVisibleNodes!==(this.maxVisibleNodes=this.getMaxVisibleNodes())){for(var d=0;d<this.tiers.length;d++){this.tiers[d].positionNodes()}}}}},{tierHeight:293,elementWidth:150,minElementMargin:25,svgNS:"http://www.w3.org/2000/svg",svgMidpoint:45,svgHeight:80,trailCurveRadius:20});var b=new a();Blocks.Tier=Blocks.Base.extend({$container:null,$trailContainer:null,$nodeContainer:null,trailHead:null,totalNodes:null,totalVisibleNodes:null,nodes:null,init:function(d){b.tiers.push(this);this.$container=c(d);this.$nodeContainer=this.$container.children(".nodes:first");this.$trailContainer=c('<svg xmlns="'+a.svgNS+'" version="1.1" class="trails" viewBox="0 0 100 '+a.svgHeight+'" style="height: '+a.svgHeight+'px" preserveAspectRatio="none"/>').prependTo(this.$container);this.trailHead=document.createElementNS(a.svgNS,"path");this.trailHead.setAttributeNS(null,"class","trail");this.trailHead.setAttributeNS(null,"vector-effect","non-scaling-stroke");this.$trailContainer[0].appendChild(this.trailHead);var g=this.$nodeContainer.children();this.totalNodes=g.length;this.nodes=[];for(var e=0;e<this.totalNodes;e++){var f=new Blocks.Node(this,g[e],e);this.nodes.push(f)}this.positionNodes()},positionNodes:function(){this.trailHead.setAttributeNS(null,"d","M 50,2 V "+(a.svgMidpoint-a.trailCurveRadius));this.totalVisibleNodes=Math.min(b.maxVisibleNodes,this.totalNodes);this.gap=100/(this.totalVisibleNodes+1);for(var e=0;e<this.totalVisibleNodes;e++){var d=this.gap+this.gap*e;this.nodes[e].setPosition(d)}for(var e=this.totalVisibleNodes;e<this.totalNodes;e++){this.nodes[e].hide()}}});Blocks.Node=Blocks.Base.extend({tier:null,$elem:null,$trail:null,index:null,pos:null,type:null,init:function(e,g,f){this.tier=e;this.$elem=c(g);this.index=f;var d=document.createElementNS(a.svgNS,"path");d.setAttributeNS(null,"class","trail");d.setAttributeNS(null,"vector-effect","non-scaling-stroke");this.tier.$trailContainer[0].appendChild(d);this.$trail=c(d);this.addListener(this.$elem,"click","onClick")},getSiblings:function(){var f=[];for(var d=0;d<this.tier.totalNodes;d++){var e=this.tier.nodes[d];if(e!=this){f.push(e)}}return f},onClick:function(){this.$elem.addClass("sel");var f=Blocks.$window.height()-Blocks.$body.outerHeight(),m=f,e=Blocks.$body.scrollTop();Blocks.$body.css("padding-bottom",m);Blocks.$body.animate({scrollTop:(e+a.tierHeight)},c.proxy(function(){Blocks.$body.css("padding-bottom",f)},this));var n=50-this.pos,k=this.getSiblings();this.$elem.animate({left:"50%"},{step:c.proxy(function(q,u){this.setTrailPosition(q);var o=n*u.pos,p=1-u.pos;for(var r=0;r<k.length;r++){var t=k[r],s=t.pos+o;t.$elem.css({opacity:p,left:s+"%"});t.$trail.css({opacity:p});t.setTrailPosition(s)}},this),complete:c.proxy(function(){},this)});var l=c('<div class="tier"/>').insertAfter(this.tier.$container),d=c('<div class="nodes"/>').appendTo(l);var h=[{title:"Chimaeric",image:"Chimaeric.png"},{title:"Pure",image:"Pure.png"},{title:"Message Marker Application",image:"MessageMarker.png"}];for(var g=0;g<h.length;g++){var j=c('<div class="node page"/>').appendTo(d);c('<img src="'+Blocks.resourceUrl+"images/screenshots/UI/"+h[g].image+'"/>').appendTo(j);c('<div class="title">'+h[g].title+"</div>").appendTo(j)}new Blocks.Tier(l,true)},setPosition:function(d){this.pos=d;this.$elem.show();this.$elem.css("left",this.pos+"%");this.setTrailPosition(this.pos);this.$elem.css({opacity:0});this.$trail.css("opacity",0);this.$elem.animate({opacity:1},{step:c.proxy(function(e,f){this.$trail.css("opacity",f.pos)},this)})},setTrailPosition:function(k){var i=Math.abs(k-50),l=(k<50?-1:1)*((i<b.trailCurveWidth*2)?(i/2):b.trailCurveWidth),f=50+l,e=k-l,m=50-a.trailCurveRadius,j=a.svgMidpoint-a.trailCurveRadius,h=a.svgMidpoint+a.trailCurveRadius,g="M 50,"+j+" Q 50,"+a.svgMidpoint+" "+f+","+a.svgMidpoint+" H "+e+" Q "+k+","+a.svgMidpoint+" "+k+","+h+" V "+(a.svgHeight-2);this.$trail[0].setAttributeNS(null,"d",g)},hide:function(){this.$elem.hide();this.$trail.hide()}})})(jQuery);