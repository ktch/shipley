/*!
 * Blocks by Pixel & Tonic
 *
 * @package   Rebrand
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2012, Pixel & Tonic, Inc.
 * @license   http://blockscms.com/license1.0.html Blocks License
 * @link      http://blockscms.com
 */
(function(d){var a=Blocks.Base.extend({messages:null,init:function(){this.messages=[];var h=d("#messages"),f=h.find(".message");for(var e=0;e<f.length;e++){var g=new b(f[e]);this.messages.push(g)}}});var b=Blocks.Base.extend({$container:null,key:null,$subject:null,$body:null,modal:null,init:function(e){this.$container=d(e);this.key=this.$container.attr("data-key");this.$subject=this.$container.find(".subject:first");this.$body=this.$container.find(".body:first");this.addListener(this.$container,"click","edit")},edit:function(){if(!this.modal){this.modal=new c(this)}else{this.modal.show()}},updateHtmlFromModal:function(){var f=this.modal.$subjectInput.val(),e=this.modal.$bodyInput.val().replace(/\n/g,"<br>");this.$subject.html(f);this.$body.html(e)}});var c=Blocks.ui.Modal.extend({message:null,$languageSelect:null,$subjectInput:null,$bodyInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,loading:false,init:function(e){this.message=e;this.base();this.loadContainer()},loadContainer:function(f){var e={key:this.message.key,language:f};d.post(Blocks.getUrl("settings/email/_message_modal"),e,d.proxy(function(g,j,h){if(!this.$container){var i=d('<form class="modal message-settings" accept-charset="UTF-8">'+g+"</form>").appendTo(Blocks.$body);this.setContainer(i);this.show()}else{this.$container.html(g)}this.$languageSelect=this.$container.find(".language:first > select");this.$subjectInput=this.$container.find(".subject:first");this.$bodyInput=this.$container.find(".body:first");this.$saveBtn=this.$container.find(".submit:first");this.$cancelBtn=this.$container.find(".cancel:first");this.$spinner=this.$container.find(".spinner:first");this.addListener(this.$languageSelect,"change","switchLanguage");this.addListener(this.$container,"submit","saveMessage");this.addListener(this.$cancelBtn,"click","cancel");setTimeout(d.proxy(function(){this.$subjectInput.focus()},this),100)},this))},switchLanguage:function(){var e=this.$languageSelect.val();this.loadContainer(e)},saveMessage:function(e){e.preventDefault();if(this.loading){return}var f={key:this.message.key,language:(this.$languageSelect.length?this.$languageSelect.val():Blocks.language),subject:this.$subjectInput.val(),body:this.$bodyInput.val()};this.$subjectInput.removeClass("error");this.$bodyInput.removeClass("error");if(!f.subject||!f.body){if(!f.subject){this.$subjectInput.addClass("error")}if(!f.body){this.$bodyInput.addClass("error")}Blocks.shake(this.$container);return}this.loading=true;this.$saveBtn.addClass("active");this.$spinner.show();Blocks.postActionRequest("emailMessages/saveMessage",f,d.proxy(function(g,i,h){if(g.success){if(f.language==Blocks.language){this.message.updateHtmlFromModal()}this.hide();Blocks.cp.displayNotice(Blocks.t("Message saved."))}else{Blocks.cp.displayError(Blocks.t("Couldnâ€™t save message."))}this.$saveBtn.removeClass("active");this.$spinner.hide();this.loading=false},this))},cancel:function(){this.hide();if(this.message){this.message.modal=null}}});new a()})(jQuery);