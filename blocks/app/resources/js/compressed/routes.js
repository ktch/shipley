/*!
 * Blocks by Pixel & Tonic
 *
 * @package   Blocks
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2012, Pixel & Tonic, Inc.
 * @license   http://blockscms.com/license1.0.html Blocks License
 * @link      http://blockscms.com
 */
(function(b){var a=Blocks.Base.extend({routes:null,$container:null,$addRouteBtn:null,sorter:null,init:function(){this.routes=[];this.$container=b("#routes");var g=this.getRoutes();for(var f=0;f<g.length;f++){var e=new d(g[f]);this.routes.push(e)}this.sorter=new Blocks.ui.DragSort(g,{axis:"y",onSortChange:b.proxy(this,"updateRouteOrder")});this.$addRouteBtn=b("#add-route-btn");this.addListener(this.$addRouteBtn,"click","addRoute")},getRoutes:function(){return this.$container.children()},updateRouteOrder:function(){var f=this.getRoutes(),g={};for(var e=0;e<f.length;e++){g["routeIds["+e+"]"]=b(f[e]).attr("data-id")}Blocks.postActionRequest("routes/updateRouteOrder",g,b.proxy(function(h,j,i){if(h.success){Blocks.cp.displayNotice(Blocks.t("New route order saved."))}else{Blocks.cp.displayError(Blocks.t("Couldn’t save new route order."))}},this))},addRoute:function(){new c()}});var d=Blocks.Base.extend({$container:null,id:null,$url:null,$template:null,modal:null,init:function(e){this.$container=b(e);this.id=this.$container.attr("data-id");this.$url=this.$container.find(".url:first");this.$template=this.$container.find(".template:first");this.addListener(this.$container,"click","edit")},edit:function(){if(!this.modal){this.modal=new c(this)}else{this.modal.show()}},updateHtmlFromModal:function(){var g="";for(var f=0;f<this.modal.urlInput.elements.length;f++){var e=this.modal.urlInput.elements[f];if(this.modal.urlInput.isText(e)){g+=e.val()}else{g+=e.prop("outerHTML")}}this.$url.html(g);this.$template.html(this.modal.$templateInput.val())}});var c=Blocks.ui.Modal.extend({route:null,$heading:null,$urlInput:null,urlElements:null,$templateInput:null,$saveBtn:null,$cancelBtn:null,$spinner:null,$deleteBtn:null,loading:false,init:function(g){this.route=g;var m=b('<form class="modal route-settings" accept-charset="UTF-8"><h1></h1><div class="field"><div class="heading"><label for="url">'+Blocks.t("If the URI looks like this")+':</label></div><div id="url" class="text url"></div><div class="url-tokens"><h4>'+Blocks.t("Add a token")+'</h4><div class="token" data-name="year" data-value="\\d{4}">'+Blocks.t("year")+'</div><div class="token" data-name="month" data-value="1?\\d">'+Blocks.t("month")+'</div><div class="token" data-name="day" data-value="[1-3]?\\d">'+Blocks.t("day")+'</div><div class="token" data-name="number" data-value="\\d+">'+Blocks.t("number")+'</div><div class="token" data-name="page" data-value="\\d+">'+Blocks.t("page")+'</div></div></div><div class="field"><div class="heading"><label for="template">'+Blocks.t("Load this template")+':</label></div><input id="template" type="text" class="text fullwidth template"></div><div class="buttons"><input type="submit" class="btn submit" value="'+Blocks.t("Save")+'"> <input type="button" class="btn cancel" value="'+Blocks.t("Cancel")+'"><div class="spinner" style="display: none;"></div><a class="delete">'+Blocks.t("Delete")+"</a></div></form>");m.appendTo(Blocks.$body);this.$heading=m.find("h1:first");this.$urlInput=m.find(".url:first");this.$templateInput=m.find(".template:first");this.$saveBtn=m.find(".submit:first");this.$cancelBtn=m.find(".cancel:first");this.$spinner=m.find(".spinner:first");this.$deleteBtn=m.find(".delete:first");if(!this.route){this.$deleteBtn.hide()}this.urlInput=new Blocks.ui.MixedInput(this.$urlInput);if(this.route){this.$heading.html(Blocks.t("Edit Route"))}else{this.$heading.html(Blocks.t("Create a new route"))}if(this.route){var j=this.route.$url.prop("childNodes");for(var h=0;h<j.length;h++){var k=j[h];if(Blocks.isTextNode(k)){var l=this.urlInput.addTextElement();l.setVal(k.nodeValue)}else{this.addUrlVar(k)}}setTimeout(b.proxy(function(){var i=this.urlInput.elements[0];this.urlInput.setFocus(i);this.urlInput.setCarotPos(i,0)},this),1);var f=this.route.$template.text();this.$templateInput.val(f)}else{setTimeout(b.proxy(function(){this.$urlInput.focus()},this),100)}this.base(m);var e=this.$container.find(".url-tokens").children("div");this.addListener(e,"mousedown",function(i){this.addUrlVar(i.currentTarget)});this.addListener(this.$container,"submit","saveRoute");this.addListener(this.$cancelBtn,"click","cancel");this.addListener(this.$deleteBtn,"click","deleteRoute")},addUrlVar:function(f){var e=b(f).clone().attr("tabindex","0");this.urlInput.addElement(e);this.addListener(e,"keydown",function(g){switch(g.keyCode){case Blocks.LEFT_KEY:setTimeout(b.proxy(function(){this.urlInput.focusPreviousElement(e)},this),1);break;case Blocks.RIGHT_KEY:setTimeout(b.proxy(function(){this.urlInput.focusNextElement(e)},this),1);break;case Blocks.DELETE_KEY:setTimeout(b.proxy(function(){this.urlInput.removeElement(e)},this),1);g.preventDefault()}})},show:function(){if(this.route){this.$heading.html(Blocks.t("Edit Route"));this.$deleteBtn.show()}this.base()},saveRoute:function(g){g.preventDefault();if(this.loading){return}var h={};if(this.route){h.routeId=this.route.id}for(var f=0;f<this.urlInput.elements.length;f++){var e=this.urlInput.elements[f];if(this.urlInput.isText(e)){h["url["+f+"]"]=e.val()}else{h["url["+f+"][0]"]=e.attr("data-name");h["url["+f+"][1]"]=e.attr("data-value")}}h.template=this.$templateInput.val();this.loading=true;this.$saveBtn.addClass("active");this.$spinner.show();Blocks.postActionRequest("routes/saveRoute",h,b.proxy(function(i,l,j){if(i.success){if(!this.route){var k=b('<div class="pane route" data-id="'+i.routeId+'"><div class="url"></div><div class="template"></div></div>');k.appendTo("#routes");this.route=new d(k);this.route.modal=this;Blocks.routes.sorter.addItems(k)}this.route.updateHtmlFromModal();this.hide();Blocks.cp.displayNotice(Blocks.t("Route saved."))}else{Blocks.cp.displayError(Blocks.t("Couldn’t save route."))}this.$saveBtn.removeClass("active");this.$spinner.hide();this.loading=false},this))},cancel:function(){this.hide();if(this.route){this.route.modal=null}},deleteRoute:function(){if(confirm(Blocks.t(("Are you sure you want to delete this route?")))){Blocks.postActionRequest("routes/deleteRoute",{routeId:this.route.id},function(){Blocks.cp.displayNotice(Blocks.t("Route deleted."))});this.route.$container.remove();this.hide()}}});Blocks.routes=new a()})(jQuery);