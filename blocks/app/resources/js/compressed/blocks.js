/*!
 * Blocks by Pixel & Tonic
 *
 * @package   Blocks
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2012, Pixel & Tonic, Inc.
 * @license   http://blockscms.com/license1.0.html Blocks License
 * @link      http://blockscms.com
 */
(function(b){if(typeof Blocks=="undefined"){Blocks={}}if(typeof Blocks.ui=="undefined"){Blocks.ui={}}Blocks.$window=b(window);Blocks.$document=b(document);Blocks.$body=b(document.body);Blocks.DELETE_KEY=8;Blocks.SHIFT_KEY=16;Blocks.CTRL_KEY=17;Blocks.ALT_KEY=18;Blocks.RETURN_KEY=13;Blocks.ESC_KEY=27;Blocks.SPACE_KEY=32;Blocks.LEFT_KEY=37;Blocks.UP_KEY=38;Blocks.RIGHT_KEY=39;Blocks.DOWN_KEY=40;Blocks.CMD_KEY=91;Blocks.navHeight=48;Blocks.fx={duration:400,delay:100};Blocks.log=function(c){if(typeof console!="undefined"&&typeof console.log=="function"){console.log(c)}};var a={"223":"ss","224":"a","225":"a","226":"a","229":"a","227":"ae","230":"ae","228":"ae","231":"c","232":"e","233":"e","234":"e","235":"e","236":"i","237":"i","238":"i","239":"i","241":"n","242":"o","243":"o","244":"o","245":"o","246":"oe","249":"u","250":"u","251":"u","252":"ue","255":"y","257":"aa","269":"ch","275":"ee","291":"gj","299":"ii","311":"kj","316":"lj","326":"nj","353":"sh","363":"uu","382":"zh","256":"aa","268":"ch","274":"ee","290":"gj","298":"ii","310":"kj","315":"lj","325":"nj","352":"sh","362":"uu","381":"zh"};Blocks.t=function(d,e){if(typeof Blocks.translations[d]!="undefined"){d=Blocks.translations[d]}if(e){for(var c in e){d=d.replace("{"+c+"}",e[c])}}return d};Blocks.hasPackage=function(c){return(b.inArray(c,Blocks.packages)!=-1)};Blocks.getUrl=function(l,g){if(l.search("://")!=-1){return l}l=Blocks.trim(l,"/");anchor="";if(Blocks.isObject(g)){var e=[];for(var c in g){var j=g[c];if(c=="#"){anchor=j}else{if(j!==null&&j!==""){e.push(c+"="+j)}}}g=e}if(Blocks.isArray(g)){g=g.join("&")}else{g=Blocks.ltrim(g,"&")}var d=Blocks.baseUrl;var i=d.indexOf("?");if(i!="-1"){var h=d.substr(i+1);d=d.substr(0,i);if(h){g=h+(g?"&"+g:"")}}if(!Blocks.usePathInfo&&l){if(g&&g.substr(0,2)=="p="){var f=g.indexOf("&");if(f!=-1){var k=g.substring(2,f-1);g=g.substr(f+1)}else{var k=g.substr(2);g=null}l=k+(l?"/"+l:"")}g="p="+l+(g?"&"+g:"");l=null}if(l){d+="/"+l}if(g){d+="?"+g}if(anchor){d+="#"+anchor}return d};Blocks.getResourceUrl=function(c,d){c=Blocks.resourceTrigger+"/"+Blocks.trim(c,"/");return Blocks.getUrl(c,d)};Blocks.getActionUrl=function(c,d){c=Blocks.actionTrigger+"/"+Blocks.trim(c,"/");return Blocks.getUrl(c,d)};Blocks.postActionRequest=function(f,e,g,d){var c=Blocks.getActionUrl(f);if(typeof e=="function"){g=e;d=g;e={}}return b.ajax(c,{type:"POST",data:e,success:g,error:d})};Blocks.numCommas=function(c){c=c.toString();var d=/(\d+)(\d{3})/;while(d.test(c)){c=c.replace(d,"$1,$2")}return c};Blocks.stringToArray=function(e){if(typeof e!="string"){return e}var c=e.split(",");for(var d=0;d<c.length;d++){c[d]=b.trim(c[d])}return c};Blocks.escapeChars=function(d){if(!Blocks.isArray(d)){d=d.split()}var e="";for(var c=0;c<d.length;c++){e+="\\"+d[c]}return e};Blocks.ltrim=function(e,d){if(!e){return e}if(d===undefined){d=" "}var c=new RegExp("^["+Blocks.escapeChars(d)+"]+");return e.replace(c,"")};Blocks.rtrim=function(e,d){if(!e){return e}if(d===undefined){d=" "}var c=new RegExp("["+Blocks.escapeChars(d)+"]+$");return e.replace(c,"")};Blocks.trim=function(d,c){d=Blocks.ltrim(d,c);d=Blocks.rtrim(d,c);return d};Blocks.filterArray=function(d,g){var e=[];for(var f=0;f<d.length;f++){if(typeof g=="function"){var c=g(d[f],f)}else{var c=d[f]}if(c){e.push(d[f])}}return e};Blocks.inArray=function(d,c){return(b.inArray(d,c)!=-1)};Blocks.removeFromArray=function(e,c){var d=b.inArray(e,c);if(d!=-1){c.splice(d,1);return true}else{return false}};Blocks.getLast=function(c){if(!c.length){return null}else{return c[c.length-1]}};Blocks.uppercaseFirst=function(c){return c.charAt(0).toUpperCase()+c.slice(1)};Blocks.lowercaseFirst=function(c){return c.charAt(0).toLowerCase()+c.slice(1)};Blocks.asciiString=function(f){var e="";for(var g=0;g<f.length;g++){var d=f.charCodeAt(g);if(d>=32&&d<128){e+=f.charAt(g)}else{if(typeof a[d]!="undefined"){e+=a[d]}}}return e};Blocks.getDist=function(d,f,c,e){return Math.sqrt(Math.pow(d-c,2)+Math.pow(f-e,2))};Blocks.hitTest=function(f,k,g){var e=b(g),h=e.offset(),d=h.left,j=h.top,c=d+e.width(),i=j+e.height();return(f>=d&&f<c&&k>=j&&k<i)};Blocks.isCursorOver=function(d,c){return Blocks.hitTest(d.pageX,d.pageY,c)};Blocks.preventOutlineOnMouseFocus=function(e){var c=b(e),d=".preventOutlineOnMouseFocus";c.on("mousedown"+d,function(){c.addClass("no-outline");c.focus()}).on("keydown"+d+" blur"+d,function(f){if(f.keyCode!=Blocks.SHIFT_KEY&&f.keyCode!=Blocks.CTRL_KEY&&f.keyCode!=Blocks.CMD_KEY){c.removeClass("no-outline")}})};Blocks.caseInsensitiveSort=function(c){return c.sort(this.caseInsensitiveCompare)};Blocks.caseInsensitiveCompare=function(d,c){d=d.toLowerCase();c=c.toLowerCase();return d<c?-1:(d>c?1:0)};Blocks.copyTextStyles=function(f,e){var c=b(f),d=b(e);d.css({lineHeight:c.css("lineHeight"),fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),fontWeight:c.css("fontWeight"),letterSpacing:c.css("letterSpacing"),textAlign:c.css("textAlign")})};Blocks.getBodyScrollTop=function(){var d=document.body.scrollTop;if(d<0){d=0}else{var c=Blocks.$body.outerHeight()-Blocks.$window.height();if(d>c){d=c}}return d};Blocks.scrollContainerToElement=function(c,g){var k=b(c),d=b(g);if(!k.length||!d.length){return}var f=k.scrollTop(),i=d.offset().top,h=k.offset().top,j=i-h;if(j<0){k.scrollTop(f+j)}else{var e=d.outerHeight(),l=k[0].clientHeight;if(j+e>l){k.scrollTop(f+(j-(l-e)))}}};Blocks.getElement=function(c){return b.makeArray(c)[0]};Blocks.createErrorList=function(f){var c=b(document.createElement("ul")).addClass("errors");for(var d=0;d<f.length;d++){var e=b(document.createElement("li"));e.appendTo(c);e.html(f[d])}return c};Blocks.isTextNode=function(c){return(c.nodeType==3)};Blocks.isArray=function(c){return(c instanceof Array)};Blocks.isJquery=function(c){return(c instanceof jQuery)};Blocks.isObject=function(c){return(typeof c=="object"&&!Blocks.isArray(c)&&!Blocks.isJquery(c)&&typeof c.nodeType=="undefined")};Blocks.isString=function(c){return(typeof c=="string")};Blocks.animateWidth=function(f,g){var d=b(f),c=d.width();d.width("auto");g();var e=d.width();d.width(c);d.animate({width:e},"fast",function(){d.width("auto")})};Blocks.shake=function(f,g){var c=b(f);if(!g){g="margin-left"}var e=parseInt(c.css(g));if(isNaN(e)){e=0}var h=25;for(var d=0;d<=10;d++){(function(j){setTimeout(function(){var i={};i[g]=e+(j%2?-1:1)*(10-j);c.animate(i,h)},(h*j))})(d)}};Blocks.findInputs=function(c){return b(c).find("input,text,textarea,select,button")};Blocks.getPostData=function(e){var f={},h={},c=Blocks.findInputs(e);for(var l=0;l<c.length;l++){var o=b(c[l]);var m=o.attr("name");if(!m){continue}var d=Blocks.getInputPostVal(o);if(d===null){continue}var n=(m.substr(-2)=="[]");if(n){var g=m.substring(0,m.length-2);if(typeof h[g]=="undefined"){h[g]=0}}if(!Blocks.isArray(d)){d=[d]}for(var k=0;k<d.length;k++){if(n){var m=g+"["+h[g]+"]";h[g]++}f[m]=d[k]}}return f};Blocks.namespaceInputName=function(c,d){return c.replace(/^([^\[\]]+)(.*)$/,d+"[$1]$2")};Blocks.getInputBasename=function(c){return c.attr("name").replace(/\[.*/,"")};Blocks.getInputPostVal=function(e){var c=e.attr("type"),d=e.val();if((c=="checkbox"||c=="radio")){if(e.prop("checked")){return d}else{return null}}else{if(Blocks.isArray(d)&&e.attr("name").substr(-2)!="[]"){if(d.length){return d[d.length-1]}else{return null}}else{return d}}};b.fn.enable=function(){return this.each(function(){var c=b(this);c.removeClass("disabled");if(c.data("activatable")){c.attr("tabindex","0")}})};b.fn.disable=function(){return this.each(function(){var c=b(this);c.addClass("disabled");if(c.data("activatable")){c.removeAttr("tabindex")}})};Blocks.Base=Base.extend({settings:null,_namespace:null,_$listeners:null,constructor:function(){this._namespace=".Blocks"+Math.floor(Math.random()*999999999);this._$listeners=b();this.init.apply(this,arguments)},init:function(){},setSettings:function(c,d){var e=(typeof this.settings=="undefined"?{}:this.settings);this.settings=b.extend(e,d,c)},_formatEvents:function(d){d=Blocks.stringToArray(d);for(var c=0;c<d.length;c++){d[c]+=this._namespace}return d.join(" ")},addListener:function(g,d,f){var c=b(g);d=this._formatEvents(d);if(typeof f=="function"){f=b.proxy(f,this)}else{f=b.proxy(this,f)}c.on(d,f);this._$listeners=this._$listeners.add(g);if(d.search(/\bactivate\b/)!=-1){if(!c.data("activatable")){var e=this._namespace+"-activate";c.on("mousedown"+e,function(h){h.preventDefault()});c.on("click"+e,function(h){h.preventDefault();if(!c.hasClass("disabled")){c.trigger("activate")}});c.on("keydown"+e,function(h){if(h.target==c[0]&&h.keyCode==Blocks.SPACE_KEY){h.preventDefault();if(!c.hasClass("disabled")){c.addClass("active");Blocks.$document.on("keyup"+e,function(i){c.removeClass("active");if(i.target==c[0]&&i.keyCode==Blocks.SPACE_KEY){i.preventDefault();c.trigger("activate")}Blocks.$document.off("keyup"+e)})}}});if(!c.hasClass("disabled")){c.attr("tabindex","0")}else{c.removeAttr("tabindex")}c.data("activatable",true)}}},removeListener:function(d,c){c=this._formatEvents(c);b(d).off(c)},removeAllListeners:function(c){b(c).off(this._namespace)},destroy:function(){this.removeAllListeners(this._$listeners)}})})(jQuery);(function(a){Blocks.ui.Select=Blocks.Base.extend({$container:null,$items:null,totalSelected:null,mousedownX:null,mousedownY:null,mouseUpTimeout:null,mouseUpTimeoutDuration:null,callbackTimeout:null,$first:null,first:null,$last:null,last:null,init:function(b,c,d){this.$container=a(b);this.$container.attr("tabindex",0);if(!d&&Blocks.isObject(c)){d=c;c=null}if(this.$container.data("select")){Blocks.log("Double-instantiating a select on an element");this.$container.data("select").destroy()}this.$container.data("select",this);this.setSettings(d,Blocks.ui.Select.defaults);this.mouseUpTimeoutDuration=(this.settings.waitForDblClick?300:0);this.$items=a();this.addItems(c);this.addListener(this.$container,"click",function(e){if(this.ignoreClick){this.ignoreClick=false}else{this.deselectAll(true)}});Blocks.preventOutlineOnMouseFocus(this.$container);this.addListener(this.$container,"keydown","onKeyDown")},getItemIndex:function(b){return this.$items.index(b[0])},isSelected:function(b){return b.hasClass("sel")},selectItem:function(b){if(!this.settings.multi){this.deselectAll()}b.addClass("sel");this.$first=this.$last=b;this.first=this.last=this.getItemIndex(b);this.totalSelected++;this.setCallbackTimeout()},selectRange:function(c){if(!this.settings.multi){return this.selectItem(c)}this.deselectAll();this.$last=c;this.last=this.getItemIndex(c);if(this.first<this.last){var b=this.first,d=this.last+1}else{var b=this.last,d=this.first+1}this.$items.slice(b,d).addClass("sel");this.totalSelected=d-b;this.setCallbackTimeout()},deselectItem:function(b){b.removeClass("sel");var c=this.getItemIndex(b);if(this.first===c){this.$first=this.first=null}if(this.last===c){this.$last=this.last=null}this.totalSelected--;this.setCallbackTimeout()},deselectAll:function(b){this.$items.removeClass("sel");if(b){this.$first=this.first=this.$last=this.last=null}this.totalSelected=0;this.setCallbackTimeout()},deselectOthers:function(b){this.deselectAll();this.selectItem(b)},toggleItem:function(b){if(!this.isSelected(b)){this.selectItem(b)}else{this.deselectItem(b)}},clearMouseUpTimeout:function(){clearTimeout(this.mouseUpTimeout)},onMouseDown:function(c){if(c.button==2){return}this.mousedownX=c.pageX;this.mousedownY=c.pageY;var b=a(a.data(c.currentTarget,"select-item"));if(c.metaKey){this.toggleItem(b)}else{if(this.first!==null&&c.shiftKey){this.selectRange(b)}else{if(!this.isSelected(b)){this.deselectAll();this.selectItem(b)}}}this.$container.focus()},onMouseUp:function(c){if(c.button==2){return}var b=a(a.data(c.currentTarget,"select-item"));if(!c.metaKey&&!c.shiftKey&&Blocks.getDist(this.mousedownX,this.mousedownY,c.pageX,c.pageY)<1){this.selectItem(b);this.clearMouseUpTimeout();this.mouseUpTimeout=setTimeout(a.proxy(function(){this.deselectOthers(b)},this),this.mouseUpTimeoutDuration)}},onKeyDown:function(d){if(d.metaKey){return}if(d.target!=this.$container[0]){return}if(!this.$items.length){return}var c=d.shiftKey?this.last:this.first;switch(d.keyCode){case Blocks.DOWN_KEY:d.preventDefault();if(this.first===null){var b=a(this.$items[0])}else{if(this.$items.length>=c+2){var b=a(this.$items[c+1])}}break;case Blocks.UP_KEY:d.preventDefault();if(this.first===null){var b=a(this.$items[this.$items.length-1])}else{if(c>0){var b=a(this.$items[c-1])}}break;case Blocks.ESC_KEY:this.deselectAll(true);break;default:return}if(typeof b=="undefined"||!b.length){return}Blocks.scrollContainerToElement(this.$container,b);if(this.first!==null&&d.shiftKey){this.selectRange(b)}else{this.deselectAll();this.selectItem(b)}},getTotalSelected:function(){return this.totalSelected},addItems:function(b){var f=a(b);for(var c=0;c<f.length;c++){var d=f[c];if(a.data(d,"select")){Blocks.log("Element was added to more than one selector");a.data(d,"select").removeItems(d)}a.data(d,"select",this);this.$items=this.$items.add(d);if(this.settings.handle){if(typeof this.settings.handle=="object"){var e=a(this.settings.handle)}else{if(typeof this.settings.handle=="string"){var e=a(d).find(this.settings.handle)}else{if(typeof this.settings.handle=="function"){var e=a(this.settings.handle(d))}}}}else{var e=a(d)}a.data(d,"select-handle",e);e.data("select-item",d);this.addListener(e,"mousedown","onMouseDown");this.addListener(e,"mouseup","onMouseUp");this.addListener(e,"click",function(g){this.ignoreClick=true})}this.totalSelected+=f.filter(".sel").length;this.updateIndexes()},removeItems:function(b){b=a.makeArray(b);for(var d=0;d<b.length;d++){var e=b[d];var c=a.inArray(e,this.$items);if(c!=-1){var f=a.data(e,"select-handle");f.data("select-item",null);a.data(e,"select",null);a.data(e,"select-handle",null);this.removeAllListeners(f);this.$items.splice(c,1)}}this.updateIndexes()},refreshItemOrder:function(){this.$items=a(this.$items)},destroy:function(){this.base();this.clearCallbackTimeout()},updateIndexes:function(){if(this.first!==null){this.first=this.getItemIndex(this.$first);this.last=this.getItemIndex(this.$last)}},resetItemOrder:function(){this.$items=a().add(this.$items);this.updateIndexes()},clearCallbackTimeout:function(){if(this.settings.onSelectionChange){clearTimeout(this.callbackTimeout)}},setCallbackTimeout:function(){if(this.settings.onSelectionChange){this.clearCallbackTimeout();this.callbackTimeout=setTimeout(a.proxy(function(){this.callbackTimeout=null;this.settings.onSelectionChange.call()},this),300)}},getSelectedItems:function(){return this.$items.filter(".sel")}},{defaults:{multi:false,waitForDblClick:false,handle:null,onSelectionChange:function(){}}})})(jQuery);(function(a){Blocks.ui.BaseDrag=Blocks.Base.extend({$items:null,dragging:false,mousedownX:null,mousedownY:null,mouseDistX:null,mouseDistY:null,$targetItem:null,targetItemMouseDiffX:null,targetItemMouseDiffY:null,mouseX:null,mouseY:null,lastMouseX:null,lastMouseY:null,init:function(b,c){if(!c&&Blocks.isObject(b)){c=b;b=null}this.settings=a.extend({},Blocks.ui.BaseDrag.defaults,c);this.$items=a();if(b){this.addItems(b)}},onMouseDown:function(c){if(c.button==2){return}if(this.$targetItem){return}if(this.settings.ignoreButtons&&c.currentTarget!=c.target){var b=a(c.target);if(b.hasClass("btn")||b.closest(".btn").length){return}}c.preventDefault();this.$targetItem=a(a.data(c.currentTarget,"drag-item"));this.mousedownX=this.mouseX=c.pageX;this.mousedownY=this.mouseY=c.pageY;var d=this.$targetItem.offset();this.targetItemMouseDiffX=c.pageX-d.left;this.targetItemMouseDiffY=c.pageY-d.top;this.addListener(Blocks.$document,"mousemove","onMouseMove");this.addListener(Blocks.$document,"mouseup","onMouseUp")},onMouseMove:function(b){b.preventDefault();if(this.settings.axis!="y"){this.mouseX=b.pageX}if(this.settings.axis!="x"){this.mouseY=b.pageY}this.mouseDistX=this.mouseX-this.mousedownX;this.mouseDistY=this.mouseY-this.mousedownY;if(!this.dragging){var c=Blocks.getDist(this.mousedownX,this.mousedownY,this.mouseX,this.mouseY);if(c>=Blocks.ui.BaseDrag.minMouseDist){this.startDragging()}else{return}}this.onDrag()},onMouseUp:function(b){this.removeAllListeners(Blocks.$document);if(this.dragging){this.stopDragging()}this.$targetItem=null},startDragging:function(){this.dragging=true;this.onDragStart()},stopDragging:function(){this.dragging=false;this.onDragStop()},onDragStart:function(){this.settings.onDragStart()},onDrag:function(){this.settings.onDrag()},onDragStop:function(){this.settings.onDragStop()},addItems:function(b){b=a.makeArray(b);for(var c=0;c<b.length;c++){var d=b[c];if(a.data(d,"drag")){Blocks.log("Element was added to more than one dragger");a.data(d,"drag").removeItems(d)}a.data(d,"drag",this);this.$items=this.$items.add(d);if(this.settings.handle){if(typeof this.settings.handle=="object"){var e=a(this.settings.handle)}else{if(typeof this.settings.handle=="string"){var e=a(d).find(this.settings.handle)}else{if(typeof this.settings.handle=="function"){var e=a(this.settings.handle(d))}}}}else{var e=a(d)}a.data(d,"drag-handle",e);e.data("drag-item",d);this.addListener(e,"mousedown","onMouseDown")}},removeItems:function(b){b=a.makeArray(b);for(var d=0;d<b.length;d++){var e=b[d];var c=a.inArray(e,this.$items);if(c!=-1){var f=a.data(e,"drag-handle");f.data("drag-item",null);a.data(e,"drag",null);a.data(e,"drag-handle",null);this.removeAllListeners(f);this.$items.splice(c,1)}}}},{minMouseDist:1,defaults:{handle:null,axis:null,ignoreButtons:true,onDragStart:function(){},onDrag:function(){},onDragStop:function(){}}})})(jQuery);(function(a){Blocks.ui.Drag=Blocks.ui.BaseDrag.extend({$draggee:null,helpers:null,helperTargets:null,helperPositions:null,helperLagIncrement:null,updateHelperPosInterval:null,init:function(b,c){if(!c&&Blocks.isObject(b)){c=b;b=null}c=a.extend({},Blocks.ui.Drag.defaults,c);this.base(b,c)},onDragStart:function(){this.helpers=[];this.helperTargets=[];this.helperPositions=[];this.getDraggee();this.draggeeIndex=a.inArray(this.$draggee[0],this.$items);this.draggeeDisplay=this.$draggee.css("display");this.createHelpers();if(this.settings.removeDraggee){this.$draggee.hide()}else{this.$draggee.css("visibility","hidden")}this.lastMouseX=this.lastMouseY=null;this.helperLagIncrement=this.helpers.length==1?0:Blocks.ui.Drag.helperLagIncrementDividend/(this.helpers.length-1);this.updateHelperPosInterval=setInterval(a.proxy(this,"updateHelperPos"),Blocks.ui.Drag.updateHelperPosInterval);this.base()},onDragStop:function(){clearInterval(this.updateHelperPosInterval);this.base()},getDraggee:function(){switch(typeof this.settings.filter){case"function":this.$draggee=this.settings.filter();break;case"string":this.$draggee=this.$items.filter(this.settings.filter);break;default:this.$draggee=this.$targetItem}this.$draggee=a([this.$targetItem[0]].concat(this.$draggee.not(this.$targetItem[0]).toArray()))},createHelpers:function(){for(var c=0;c<this.$draggee.length;c++){var e=a(this.$draggee[c]),d=e.clone();d.css({width:e.width(),height:e.height(),margin:0});if(typeof this.settings.helper=="function"){d=this.settings.helper(d)}else{if(this.settings.helper){d=a(this.settings.helper).append(d)}}d.appendTo(document.body);var b=this.getHelperTarget(c);d.css({position:"absolute",top:b.top,left:b.left,zIndex:Blocks.ui.Drag.helperZindex,opacity:this.settings.helperOpacity});this.helperPositions[c]={top:b.top,left:b.left};this.helpers.push(d)}},getHelperTarget:function(b){return{left:this.mouseX-this.targetItemMouseDiffX+(b*Blocks.ui.Drag.helperSpacingX),top:this.mouseY-this.targetItemMouseDiffY+(b*Blocks.ui.Drag.helperSpacingY)}},updateHelperPos:function(){if(this.mouseX!==this.lastMouseX||this.mouseY!==this.lastMouseY){for(var c=0;c<this.helpers.length;c++){this.helperTargets[c]=this.getHelperTarget(c)}this.lastMouseX=this.mouseX;this.lastMouseY=this.mouseY}for(var b=0;b<this.helpers.length;b++){var d=Blocks.ui.Drag.helperLagBase+(this.helperLagIncrement*b);this.helperPositions[b]={left:this.helperPositions[b].left+((this.helperTargets[b].left-this.helperPositions[b].left)/d),top:this.helperPositions[b].top+((this.helperTargets[b].top-this.helperPositions[b].top)/d)};this.helpers[b].css(this.helperPositions[b])}},returnHelpersToDraggee:function(){for(var b=0;b<this.$draggee.length;b++){var e=a(this.$draggee[b]),d=this.helpers[b],c=e.offset();(function(g,f){f.animate({left:c.left,top:c.top},"fast",function(){g.css("visibility","visible");f.remove()})})(e,d)}}},{helperZindex:1000,helperLagBase:1,helperLagIncrementDividend:1.5,updateHelperPosInterval:20,helperSpacingX:5,helperSpacingY:5,defaults:{removeDraggee:false,helperOpacity:1,helper:null}})})(jQuery);(function(a){Blocks.ui.DragMove=Blocks.ui.BaseDrag.extend({onDrag:function(b,c){this.$targetItem.css({left:this.mouseX-this.targetItemMouseDiffX,top:this.mouseY-this.targetItemMouseDiffY})}})})(jQuery);(function(a){Blocks.ui.DragDrop=Blocks.ui.Drag.extend({$dropTargets:null,$activeDropTarget:null,init:function(b){b=a.extend({},Blocks.ui.DragDrop.defaults,b);this.base(b)},onDragStart:function(){if(this.settings.dropTargets){if(typeof this.settings.dropTargets=="function"){this.$dropTargets=a(this.settings.dropTargets())}else{this.$dropTargets=a(this.settings.dropTargets)}if(!this.$dropTargets.length){this.$dropTargets=null}}this.$activeDropTarget=null;this.base()},onDrag:function(){if(this.$dropTargets){var b;for(var c=0;c<this.$dropTargets.length;c++){var d=this.$dropTargets[c];if(Blocks.hitTest(this.mouseX,this.mouseY,d)){b=d;break}}if(!this.$activeDropTarget||b!=this.$activeDropTarget[0]){if(this.$activeDropTarget){this.$activeDropTarget.removeClass(this.settings.activeDropTargetClass)}this.$activeDropTarget=a(b);if(this.$activeDropTarget){this.$activeDropTarget.addClass(this.settings.activeDropTargetClass)}this.settings.onDropTargetChange()}}this.base()},onDragStop:function(){if(this.$dropTargets&&this.$activeDropTarget){this.$activeDropTarget.removeClass(this.settings.activeDropTargetClass)}this.base()},fadeOutHelpers:function(){for(var b=0;b<this.helpers.length;b++){(function(c){c.fadeOut("fast",function(){c.remove()})})(this.helpers[b])}}},{defaults:{dropTargets:null,onDropTargetChange:function(){}}})})(jQuery);(function(a){Blocks.ui.DragSort=Blocks.ui.Drag.extend({$insertion:null,startDraggeeIndex:null,closestItemIndex:null,init:function(b,c){if(!c&&Blocks.isObject(b)){c=b;b=null}c=a.extend({},Blocks.ui.DragSort.defaults,c);this.base(b,c)},onDragStart:function(){this.setInsertion();this.setMidpoints();this.closestItem=-1;this.base();this.startDraggeeIndex=this.draggeeIndex},setInsertion:function(){if(this.settings.insertion){if(typeof this.settings.insertion=="function"){this.$insertion=a(this.settings.insertion())}else{this.$insertion=a(this.settings.insertion)}}},setMidpoints:function(){for(var c=0;c<this.$items.length;c++){var b=a(this.$items[c]),d=b.offset();b.data("midpoint",{left:d.left+b.width()/2,top:d.top+b.height()/2})}},onDrag:function(){if(this.settings.container&&!Blocks.hitTest(this.mouseX,this.mouseY,a(this.settings.container))){if(this.closestItemIndex!=-1){this.$insertion.remove();this.closestItemIndex=-1}}else{if(this.closestItemIndex!==(this.closestItemIndex=this.getClosestItemIndex())){this.$closestItem=a(this.$items[this.closestItemIndex]);this.onInsertionPointChange()}}this.base()},getClosestItemIndex:function(){var f=-1,e;for(var d=0;d<this.$items.length;d++){var b=a(this.$items[d]),c=b.data("midpoint"),g=Blocks.getDist(c.left,c.top,this.mouseX,this.mouseY);if(f==-1||g<e){f=d;e=g}}return f},onInsertionPointChange:function(){if(this.closestItemIndex>=this.draggeeIndex&&this.closestItemIndex<this.draggeeIndex+this.$draggee.length){return}if(this.closestItemIndex>this.draggeeIndex){this.$draggee.insertAfter(this.$closestItem)}else{this.$draggee.insertBefore(this.$closestItem)}this.$items=a().add(this.$items);this.$items=a().add(this.$items);this.draggeeIndex=a.inArray(this.$draggee[0],this.$items);this.closestItemIndex=a.inArray(this.$closestItem[0],this.$items);this.setMidpoints();if(this.$insertion){this.$insertion.insertBefore(this.$draggee)}this.settings.onInsertionPointChange()},onDragStop:function(){if(this.$insertion){this.$insertion.remove()}this.$draggee.css({display:this.draggeeDisplay,visibility:"hidden"});this.returnHelpersToDraggees();this.base();if(this.startDraggeeIndex!=this.draggeeIndex){this.settings.onSortChange()}},returnHelpersToDraggees:function(){for(var b=0;b<this.$draggee.length;b++){var e=a(this.$draggee[b]),d=this.helpers[b],c=e.offset();(function(g,f){f.animate({left:c.left,top:c.top},"fast",function(){g.css("visibility","visible");f.remove()})})(e,d)}}},{defaults:{container:null,insertion:null,onInsertionPointChange:function(){},onSortChange:function(){}}})})(jQuery);(function(a){Blocks.ui.DataTableSorter=Blocks.ui.DragSort.extend({$table:null,init:function(d,c){this.$table=a(d);var b=this.$table.children("tbody").children(":not(.filler)");c=a.extend({},Blocks.ui.DataTableSorter.defaults,c);c.helper=a.proxy(this,"getHelper");c.axis="y";this.base(b,c)},getHelper:function(d){var j=a('<div class="'+this.settings.helperClass+'"/>').appendTo(Blocks.$body),e=a("<table/>").appendTo(j),c=a("<tbody/>").appendTo(e);d.appendTo(c);e.width(this.$table.width());e.prop("className",this.$table.prop("className"));var h=this.$table.find("tr:first"),b=h.children(),g=d.children();for(var f=0;f<g.length;f++){a(g[f]).width(a(b[f]).width())}return j}},{defaults:{handle:".move",helperClass:"datatablesorthelper"}})})(jQuery);(function(a){Blocks.ui.InputGenerator=Blocks.Base.extend({$source:null,$target:null,listening:null,init:function(b,c){this.$source=a(b);this.$target=a(c);this.startListening()},startListening:function(){if(this.listening){return}this.listening=true;this.addListener(this.$source,"keypress,keyup,change,blur","updateTarget");this.addListener(this.$target,"keypress,keyup,change","stopListening")},stopListening:function(){if(!this.listening){return}this.listening=false;this.removeAllListeners(this.$source);this.removeAllListeners(this.$target)},updateTarget:function(){var c=this.$source.val(),b=this.generateTargetValue(c);this.$target.val(b)},generateTargetValue:function(b){return b}})})(jQuery);(function(a){Blocks.ui.HandleGenerator=Blocks.ui.InputGenerator.extend({generateTargetValue:function(e){var c=e.replace("/<(.*?)>/g","");c=c.toLowerCase();c=Blocks.asciiString(c);c=c.replace(/^[^a-z]+/,"");var d=Blocks.filterArray(c.split(/[^a-z0-9]+/)),c="";for(var b=0;b<d.length;b++){if(b==0){c+=d[b]}else{c+=d[b].charAt(0).toUpperCase()+d[b].substr(1)}}return c}})})(jQuery);(function(a){Blocks.ui.EntryUrlFormatGenerator=Blocks.ui.InputGenerator.extend({generateTargetValue:function(c){c=c.replace("/<(.*?)>/g","");c=c.toLowerCase();c=Blocks.asciiString(c);c=c.replace(/^[^a-z]+/,"");c=c.replace(/[^a-z0-9]+$/,"");var b=Blocks.filterArray(c.split(/[^a-z0-9]+/));if(b.length){return b.join("-")+"/{slug}"}return""}})})(jQuery);(function(a){Blocks.ui.SlugGenerator=Blocks.ui.InputGenerator.extend({generateTargetValue:function(c){c=c.replace("/<(.*?)>/g","");c=c.toLowerCase();c=Blocks.asciiString(c);c=c.replace(/^[^a-z0-9]+/,"");c=c.replace(/[^a-z0-9]+$/,"");var b=Blocks.filterArray(c.split(/[^a-z0-9]+/));if(b.length){return b.join("-")}else{return""}}})})(jQuery);(function(a){Blocks.ui.NiceText=Blocks.Base.extend({$input:null,$hint:null,$stage:null,autoHeight:null,focussed:false,showingHint:false,val:null,stageHeight:null,minHeight:null,interval:null,init:function(b,c){this.$input=a(b);this.settings=a.extend({},Blocks.ui.NiceText.defaults,c);if(this.$input.data("nicetext")){Blocks.log("Double-instantiating a transparent text input on an element");this.$input.data("nicetext").destroy()}this.$input.data("nicetext",this);this.getVal();this.autoHeight=(this.settings.autoHeight&&this.$input.prop("nodeName")=="TEXTAREA");if(this.autoHeight){this.minHeight=this.getStageHeight("");this.setHeight();this.addListener(Blocks.$window,"resize","setHeight")}if(this.settings.hint){this.$hintContainer=a('<div class="texthint-container"/>').insertBefore(this.$input);this.$hint=a('<div class="texthint">'+this.settings.hint+"</div>").appendTo(this.$hintContainer);this.$hint.css({top:(parseInt(this.$input.css("borderTopWidth"))+parseInt(this.$input.css("paddingTop"))),left:(parseInt(this.$input.css("borderLeftWidth"))+parseInt(this.$input.css("paddingLeft"))+1)});Blocks.copyTextStyles(this.$input,this.$hint);if(this.val){this.$hint.hide()}else{this.showingHint=true}this.addListener(this.$hint,"mousedown",function(d){d.preventDefault();this.$input.focus()})}this.addListener(this.$input,"focus","onFocus");this.addListener(this.$input,"blur","onBlur");this.addListener(this.$input,"keydown","onKeyDown")},getVal:function(){this.val=this.$input.val();return this.val},showHint:function(){this.$hint.fadeIn(Blocks.ui.NiceText.hintFadeDuration);this.showingHint=true},hideHint:function(){this.$hint.fadeOut(Blocks.ui.NiceText.hintFadeDuration);this.showingHint=false},checkInput:function(){var b=(this.val!==this.getVal());if(b){if(this.$hint){if(this.showingHint&&this.val){this.hideHint()}else{if(!this.showingHint&&!this.val){this.showHint()}}}if(this.autoHeight){this.setHeight()}}return b},buildStage:function(){this.$stage=a("<stage/>").appendTo(Blocks.$body);this.$stage.css({position:"absolute",top:-9999,left:-9999,wordWrap:"break-word"});Blocks.copyTextStyles(this.$input,this.$stage)},getStageHeight:function(c){if(!this.$stage){this.buildStage()}this.$stage.css("width",this.$input.width());if(!c){c="&nbsp;";for(var b=1;b<this.$input.prop("rows");b++){c+="<br/>&nbsp;"}}else{c=c.replace(/&/g,"&amp;");c=c.replace(/</g,"&lt;");c=c.replace(/>/g,"&gt;");c=c.replace(/ /g,"&nbsp;");c=c.replace(/[\n\r]$/g,"<br/>&nbsp;");c=c.replace(/[\n\r]/g,"<br/>");c+="<br/>&nbsp;"}this.$stage.html(c);this.stageHeight=this.$stage.height();return this.stageHeight},setHeight:function(){if(this.stageHeight!==this.getStageHeight(this.val)){var b=this.stageHeight;if(b<this.minHeight){b=this.minHeight}this.$input.height(b)}},onFocus:function(){this.focussed=true;this.interval=setInterval(a.proxy(this,"checkInput"),Blocks.ui.NiceText.interval);this.checkInput()},onBlur:function(){this.focussed=false;clearInterval(this.interval);this.checkInput()},onKeyDown:function(){setTimeout(a.proxy(this,"checkInput"),1)},destroy:function(){this.base();this.$hint.remove();this.$stage.remove()}},{interval:100,hintFadeDuration:50,defaults:{autoHeight:true}});a.fn.nicetext=function(){return this.each(function(){if(!a.data(this,"text")){new Blocks.ui.NiceText(this,{hint:this.getAttribute("data-hint")})}})};Blocks.$document.ready(function(){a(".nicetext").nicetext()})})(jQuery);(function(a){Blocks.ui.Modal=Blocks.Base.extend({$container:null,$header:null,$body:null,$scrollpane:null,$footer:null,$footerBtns:null,$submitBtn:null,_headerHeight:null,_footerHeight:null,visible:false,dragger:null,init:function(b,c){if(!c&&Blocks.isObject(b)){c=b;items=null}this.setSettings(c,Blocks.ui.Modal.defaults);if(b){this.setContainer(b);this.show()}Blocks.ui.Modal.instances.push(this)},setContainer:function(b){this.$container=a(b);if(this.$container.data("modal")){Blocks.log("Double-instantiating a modal on an element");this.$container.data("modal").destroy()}this.$container.data("modal",this);this.$header=this.$container.find(".pane-head:first");this.$body=this.$container.find(".pane-body:first");this.$scrollpane=this.$body.children(".scrollpane:first");this.$footer=this.$container.find(".pane-foot:first");this.$footerBtns=this.$footer.find(".btn");this.$submitBtn=this.$footerBtns.filter(".submit:first");this.$closeBtn=this.$footerBtns.filter(".close:first");if(this.settings.draggable){var c=this.$header.add(this.$footer);if(c.length){this.dragger=new Blocks.ui.DragMove(this.$container,{handle:this.$container})}}this.addListener(this.$container,"keydown","onKeyDown");this.addListener(this.$closeBtn,"click","hide")},show:function(){if(Blocks.ui.Modal.visibleModal){Blocks.ui.Modal.visibleModal.hide()}if(this.$container){this.$container.show();this.centerInViewport();this.$container.delay(50).fadeIn();this.addListener(Blocks.$window,"resize","centerInViewport")}this.visible=true;Blocks.ui.Modal.visibleModal=this;Blocks.ui.Modal.$shade.fadeIn(50);this.addListener(Blocks.ui.Modal.$shade,"click","hide")},hide:function(){if(this.$container){this.$container.fadeOut("fast");this.removeListener(Blocks.$window,"resize")}this.visible=false;Blocks.ui.Modal.visibleModal=null;Blocks.ui.Modal.$shade.fadeOut("fast");this.removeListener(Blocks.ui.Modal.$shade,"click")},getHeight:function(){if(!this.$container){throw Blocks.t("Attempted to get the height of a modal whose container has not been set.")}if(!this.visible){this.$container.show()}var b=this.$container.outerHeight();if(!this.visible){this.$container.hide()}return b},getWidth:function(){if(!this.$container){throw Blocks.t("Attempted to get the width of a modal whose container has not been set.")}if(!this.visible){this.$container.show()}var b=this.$container.outerWidth();if(!this.visible){this.$container.hide()}return b},centerInViewport:function(){if(!this.$container){throw Blocks.t("Attempted to position a modal whose container has not been set.")}var c=Blocks.$window.width(),e=Blocks.$window.height(),b=this.getWidth(),d=this.getHeight(),g=Math.round((c-b)/2),f=Math.round((e-d)/2);this.$container.css({top:f,left:g})},positionRelativeTo:function(f){if(!this.$container){throw Blocks.t("Attempted to position a modal whose container has not been set.")}var c=a(f),h=c.offset(),e=Blocks.$body.scrollTop(),d=h.top-e,b=this.getHeight();if(b<d+Blocks.navHeight+Blocks.ui.Modal.relativeElemPadding*2){var g=h.top-b-Blocks.ui.Modal.relativeElemPadding}else{var g=h.top+c.height()+Blocks.ui.Modal.relativeElemPadding}this.$container.css({top:g,left:h.left})},onKeyDown:function(b){if(b.target.nodeName!="TEXTAREA"&&b.keyCode==Blocks.RETURN_KEY){this.$submitBtn.click()}},destroy:function(){this.base();if(this.dragger){this.dragger.destroy()}}},{relativeElemPadding:8,defaults:{draggable:true},instances:[],visibleModal:null,$shade:a('<div class="modal-shade"/>').appendTo(Blocks.$body)})})(jQuery);(function(a){Blocks.ui.HUD=Blocks.Base.extend({init:function(b,d,c){this.$trigger=a(b);this.$contents=a(d);this.settings=a.extend({},Blocks.ui.HUD.defaults,c);this.showing=false;this.$hud=a('<div class="hud" />').appendTo(document.body).hide();this.$tip=a('<div class="tip" />').appendTo(this.$hud);this.$contents.appendTo(this.$hud);this.addListener(this.$trigger,"click","show")},show:function(d){if(this.showing){return}if(Blocks.ui.HUD.active){Blocks.ui.HUD.active.hide()}this.$hud.show();this.windowWidth=a(window).width();this.windowHeight=a(window).height();this.windowScrollLeft=a(window).scrollLeft();this.windowScrollTop=a(window).scrollTop();this.triggerWidth=this.$trigger.width()+parseInt(this.$trigger.css("paddingLeft"))+parseInt(this.$trigger.css("borderLeftWidth"))+parseInt(this.$trigger.css("paddingRight"))+parseInt(this.$trigger.css("borderRightWidth"));this.triggerHeight=this.$trigger.height()+parseInt(this.$trigger.css("paddingTop"))+parseInt(this.$trigger.css("borderTopWidth"))+parseInt(this.$trigger.css("paddingBottom"))+parseInt(this.$trigger.css("borderBottomWidth"));this.triggerOffset=this.$trigger.offset();this.triggerOffsetRight=this.triggerOffset.left+this.triggerWidth;this.triggerOffsetBottom=this.triggerOffset.top+this.triggerHeight;this.triggerOffsetLeft=this.triggerOffset.left;this.triggerOffsetTop=this.triggerOffset.top;this.width=this.$hud.width();this.height=this.$hud.height();this.minHorizontalClearance=this.width+this.settings.triggerSpacing+this.settings.windowSpacing;this.minVerticalClearance=this.height+this.settings.triggerSpacing+this.settings.windowSpacing;this.rightClearance=this.windowWidth+this.windowScrollLeft-this.triggerOffsetRight;this.bottomClearance=this.windowHeight+this.windowScrollTop-this.triggerOffsetBottom;this.leftClearance=this.triggerOffsetLeft-this.windowScrollLeft;this.topClearance=this.triggerOffsetTop-this.windowScrollTop;if(this.bottomClearance>=this.minVerticalClearance){var g=this.triggerOffsetBottom+this.settings.triggerSpacing;this.$hud.css("top",g);this._setLeftPos();this._setTipClass("top")}else{if(this.rightClearance>=this.minHorizontalClearance){var f=this.triggerOffsetRight+this.settings.triggerSpacing;this.$hud.css("left",f);this._setTopPos();this._setTipClass("left")}else{if(this.leftClearance>=this.minHorizontalClearance){var f=this.triggerOffsetLeft-(this.width+this.settings.triggerSpacing);this.$hud.css("left",f);this._setTopPos();this._setTipClass("right")}else{if(this.topClearance>=this.minVerticalClearance){var g=this.triggerOffsetTop-(this.height+this.settings.triggerSpacing);this.$hud.css("top",g);this._setLeftPos();this._setTipClass("bottom")}else{var c=this.minHorizontalClearance-this.rightClearance,e=this.minVerticalClearance-this.bottomClearance;if(c>=e){var f=this.windowWidth-(this.width+this.settings.windowSpacing),b=this.triggerOffsetLeft+this.settings.triggerSpacing;if(f<b){f=b}this.$hud.css("left",f);this._setTopPos();this._setTipClass("left")}else{var g=this.windowHeight-(this.height+this.settings.windowSpacing),h=this.triggerOffsetTop+this.settings.triggerSpacing;if(g<h){g=h}this.$hud.css("top",g);this._setLeftPos();this._setTipClass("top")}}}}}if(d.stopPropagation){d.stopPropagation()}this.addListener(Blocks.$body,"click","hide");this.showing=true;Blocks.ui.HUD.active=this;this.settings.onShow()},_setTopPos:function(){var e=(this.windowHeight+this.windowScrollTop)-(this.height+this.settings.windowSpacing),f=(this.windowScrollTop+this.settings.windowSpacing),b=this.triggerOffsetTop+Math.round(this.triggerHeight/2),d=b-Math.round(this.height/2);if(d>e){d=e}if(d<f){d=f}this.$hud.css("top",d);var c=(b-d)-(this.settings.tipWidth/2);this.$tip.css({top:c,left:""})},_setLeftPos:function(){var d=(this.windowWidth+this.windowScrollLeft)-(this.width+this.settings.windowSpacing),c=(this.windowScrollLeft+this.settings.windowSpacing),e=this.triggerOffsetLeft+Math.round(this.triggerWidth/2),f=e-Math.round(this.width/2);if(f>d){f=d}if(f<c){f=c}this.$hud.css("left",f);var b=(e-f)-(this.settings.tipWidth/2);this.$tip.css({left:b,top:""})},_setTipClass:function(b){if(this.tipClass){this.$tip.removeClass(this.tipClass)}this.tipClass=b;this.$tip.addClass(b)},hide:function(){this.$hud.hide();this.showing=false;Blocks.ui.HUD.active=null;this.settings.onHide()}});Blocks.ui.HUD.defaults={triggerSpacing:7,windowSpacing:20,tipWidth:8,onShow:function(){},onHide:function(){}}})(jQuery);(function(a){Blocks.ui.MenuBtn=Blocks.Base.extend({$btn:null,menu:null,showingMenu:false,init:function(b,d){this.$btn=a(b);if(this.$btn.data("menubtn")){Blocks.log("Double-instantiating a menu button on an element");this.$btn.data("menubtn").destroy()}this.$btn.data("menubtn",this);this.setSettings(d,Blocks.ui.MenuBtn.defaults);var c=this.$btn.next(".menu");this.menu=new Blocks.ui.Menu(c,{onOptionSelect:a.proxy(this,"onOptionSelect")});this.addListener(this.$btn,"mousedown","onMouseDown")},onMouseDown:function(b){if(b.button!=0||b.metaKey){return}b.preventDefault();if(this.showingMenu){this.hideMenu()}else{this.showMenu()}},showMenu:function(){this.menu.setPosition(this.$btn);this.menu.show();this.$btn.addClass("active");this.showingMenu=true;setTimeout(a.proxy(function(){this.addListener(Blocks.$document,"mousedown","onMouseDown")},this),1)},hideMenu:function(){this.menu.hide();this.$btn.removeClass("active");this.showingMenu=false;this.removeListener(Blocks.$document,"mousedown")},onOptionSelect:function(b){this.settings.onOptionSelect(b)}},{defaults:{onOptionSelect:function(){}}});Blocks.ui.Menu=Blocks.Base.extend({settings:null,$container:null,$options:null,init:function(b,c){this.setSettings(c,Blocks.ui.Menu.defaults);this.$container=a(b).appendTo(Blocks.$body);this.$options=this.$container.find("li");this.addListener(this.$options,"mousedown","selectOption")},setPosition:function(d){var e=d.offset(),c=d.outerWidth(),b={top:e.top+d.outerHeight(),minWidth:(c-32)};if(this.$container.attr("data-align")=="right"){b.right=1+Blocks.$window.width()-(e.left+c)}else{b.left=1+e.left}this.$container.css(b)},show:function(){this.$container.fadeIn(50)},hide:function(){this.$container.fadeOut("fast")},selectOption:function(b){this.settings.onOptionSelect(b.currentTarget)}},{defaults:{onOptionSelect:function(){}}});a.fn.menubtn=function(){return this.each(function(){if(!a.data(this,"menubtn")){new Blocks.ui.MenuBtn(this)}})};Blocks.$document.ready(function(){a(".menubtn").menubtn()})})(jQuery);(function(a){Blocks.ui.Pill=Blocks.Base.extend({$outerContainer:null,$innerContainer:null,$btns:null,$selectedBtn:null,$input:null,init:function(b){this.$outerContainer=a(b);if(this.$outerContainer.data("pill")){Blocks.log("Double-instantiating a pill on an element");this.$outerContainer.data("pill").destroy()}this.$outerContainer.data("pill",this);this.$innerContainer=this.$outerContainer.find(".btngroup:first");this.$btns=this.$innerContainer.find(".btn");this.$selectedBtn=this.$btns.filter(".active:first");this.$input=this.$outerContainer.find("input:first");Blocks.preventOutlineOnMouseFocus(this.$innerContainer);this.addListener(this.$btns,"mousedown","onMouseDown");this.addListener(this.$innerContainer,"keydown","onKeyDown")},select:function(b){this.$selectedBtn.removeClass("active");var c=a(b);c.addClass("active");this.$input.val(c.attr("data-value"));this.$selectedBtn=c},onMouseDown:function(b){this.select(b.currentTarget)},_getSelectedBtnIndex:function(){if(typeof this.$selectedBtn[0]!="undefined"){return a.inArray(this.$selectedBtn[0],this.$btns)}else{return -1}},onKeyDown:function(d){switch(d.keyCode){case Blocks.RIGHT_KEY:if(!this.$selectedBtn.length){this.select(this.$btns[this.$btns.length-1])}else{var b=this._getSelectedBtnIndex()+1;if(typeof this.$btns[b]!="undefined"){this.select(this.$btns[b])}}d.preventDefault();break;case Blocks.LEFT_KEY:if(!this.$selectedBtn.length){this.select(this.$btns[0])}else{var c=this._getSelectedBtnIndex()-1;if(typeof this.$btns[c]!="undefined"){this.select(this.$btns[c])}}d.preventDefault();break}}});a.fn.pill=function(){return this.each(function(){if(!a.data(this,"pill")){new Blocks.ui.Pill(this)}})};Blocks.$document.ready(function(){a(".pill").pill()})})(jQuery);(function(a){Blocks.ui.SelectMenu=Blocks.ui.Menu.extend({init:function(c,b,d,e){if(typeof d=="function"){e=d;d={}}d=a.extend({},Blocks.ui.SelectMenu.defaults,d);this.base(c,b,d,e);this.selected=-1},build:function(){this.base();if(this.selected!=-1){this._addSelectedOptionClass(this.selected)}},select:function(b){if(b==this.selected){return}if(this.dom.ul){if(this.selected!=-1){this.dom.options[this.selected].className=""}this._addSelectedOptionClass(b)}this.selected=b;this.setBtnText(a(this.options[b].label).text());this.base(b)},_addSelectedOptionClass:function(b){this.dom.options[b].className="sel"},setBtnText:function(b){this.dom.$btnLabel.text(b)}});Blocks.ui.SelectMenu.defaults={ulClass:"menu select"}})(jQuery);(function(a){Blocks.ui.LightSwitch=Blocks.Base.extend({settings:null,$outerContainer:null,$innerContainer:null,$input:null,$toggleTarget:null,on:null,dragger:null,dragStartMargin:null,init:function(b,c){this.$outerContainer=a(b);if(this.$outerContainer.data("lightswitch")){Blocks.log("Double-instantiating a switch on an element");this.$outerContainer.data("lightswitch").destroy()}this.$outerContainer.data("lightswitch",this);this.setSettings(c,Blocks.ui.LightSwitch.defaults);this.$innerContainer=this.$outerContainer.find(".container:first");this.$input=this.$outerContainer.find("input:first");this.$toggleTarget=a(this.$outerContainer.attr("data-toggle"));this.on=this.$outerContainer.hasClass("on");this.addListener(this.$outerContainer,"mousedown","_onMouseDown");this.addListener(this.$outerContainer,"keydown","_onKeyDown");this.dragger=new Blocks.ui.BaseDrag(this.$outerContainer,{axis:"x",ignoreButtons:false,onDragStart:a.proxy(this,"_onDragStart"),onDrag:a.proxy(this,"_onDrag"),onDragStop:a.proxy(this,"_onDragStop")})},turnOn:function(){this.$innerContainer.stop().animate({marginLeft:0},"fast");this.$input.val("y");this.on=true;this.settings.onChange();this.$toggleTarget.show();this.$toggleTarget.height("auto");var b=this.$toggleTarget.height();this.$toggleTarget.height(0);this.$toggleTarget.stop().animate({height:b},"fast",a.proxy(function(){this.$toggleTarget.height("auto")},this))},turnOff:function(){this.$innerContainer.stop().animate({marginLeft:Blocks.ui.LightSwitch.offMargin},"fast");this.$input.val("");this.on=false;this.settings.onChange();this.$toggleTarget.stop().animate({height:0},"fast")},toggle:function(b){if(!this.on){this.turnOn()}else{this.turnOff()}},_onMouseDown:function(){this.addListener(Blocks.$document,"mouseup","_onMouseUp")},_onMouseUp:function(){this.removeListener(Blocks.$document,"mouseup");if(!this.dragger.dragging){this.toggle()}},_onKeyDown:function(b){switch(b.keyCode){case Blocks.SPACE_KEY:this.toggle();b.preventDefault();break;case Blocks.RIGHT_KEY:this.turnOn();b.preventDefault();break;case Blocks.LEFT_KEY:this.turnOff();b.preventDefault();break}},_getMargin:function(){return parseInt(this.$innerContainer.css("marginLeft"))},_onDragStart:function(){this.dragStartMargin=this._getMargin()},_onDrag:function(){var b=this.dragStartMargin+this.dragger.mouseDistX;if(b<Blocks.ui.LightSwitch.offMargin){b=Blocks.ui.LightSwitch.offMargin}else{if(b>0){b=0}}this.$innerContainer.css("marginLeft",b)},_onDragStop:function(){var b=this._getMargin();if(b>-16){this.turnOn()}else{this.turnOff()}},destroy:function(){this.base();this.dragger.destroy()}},{offMargin:-50,defaults:{onChange:function(){}}});a.fn.lightswitch=function(c,b,d){if(c=="settings"){if(typeof b=="string"){c={};c[b]=d}else{c=b}return this.each(function(){var e=a.data(this,"lightswitch");if(e){e.setSettings(c)}})}return this.each(function(){if(!a.data(this,"lightswitch")){new Blocks.ui.LightSwitch(this,c)}})};Blocks.$document.ready(function(){a(".lightswitch").lightswitch()})})(jQuery);(function(a){Blocks.ui.PasswordInput=Blocks.Base.extend({$passwordInput:null,$textInput:null,$currentInput:null,$showPasswordToggle:null,showingPassword:null,showingCapsIcon:null,init:function(b){this.$passwordInput=a(b);if(this.$passwordInput.data("passwordInput")){Blocks.log("Double-instantiating a password input on an element");this.$passwordInput.data("passwordInput").destroy()}this.$passwordInput.data("passwordInput",this);this.showingCapsIcon=false;this.$showPasswordToggle=a("<a/>").hide();this.$showPasswordToggle.addClass("password-toggle");this.$showPasswordToggle.insertAfter(this.$passwordInput);this.addListener(this.$showPasswordToggle,"mousedown","onToggleMouseDown");this.hidePassword()},setCurrentInput:function(b){if(this.$currentInput){b.addClass("focus");this.$currentInput.replaceWith(b);b.focus();b.removeClass("focus");b.val(this.$currentInput.val())}this.$currentInput=b;this.addListener(this.$currentInput,"focus","onFocus");this.addListener(this.$currentInput,"keypress","onKeyPress");this.addListener(this.$currentInput,"keypress,keyup,change,blur","onInputChange")},updateToggleLabel:function(b){this.$showPasswordToggle.text(b)},showPassword:function(){if(this.showingPassword){return}this.hideCapsIcon();if(!this.$textInput){this.$textInput=this.$passwordInput.clone(true);this.$textInput.attr("type","text")}this.setCurrentInput(this.$textInput);this.updateToggleLabel(Blocks.t("Hide"));this.showingPassword=true},hidePassword:function(){if(this.showingPassword===false){return}this.setCurrentInput(this.$passwordInput);this.updateToggleLabel(Blocks.t("Show"));this.showingPassword=false;this.addListener(this.$passwordInput,"keydown","onKeyDown")},togglePassword:function(){if(this.showingPassword){this.hidePassword()}else{this.showPassword()}},showCapsIcon:function(){if(this.showingCapsIcon){return}this.$currentInput.addClass("capslock");this.showingCapsIcon=true},hideCapsIcon:function(){if(!this.showingCapsIcon){return}this.$currentInput.removeClass("capslock");this.showingCapsIcon=false},onFocus:function(){this.hideCapsIcon()},onKeyDown:function(b){if(b.keyCode==Blocks.ALT_KEY&&this.$currentInput.val()){this.showPassword();this.$showPasswordToggle.hide();this.addListener(this.$textInput,"keyup","onKeyUp")}},onKeyUp:function(b){b.preventDefault();if(b.keyCode==Blocks.ALT_KEY){this.hidePassword();this.$showPasswordToggle.show()}},onKeyPress:function(b){if(this.showingPassword){return}if(!b.shiftKey&&!b.metaKey){var c=String.fromCharCode(b.which);if(c.toUpperCase()===c&&c.toLowerCase()!==c){this.showCapsIcon()}else{if(c.toLowerCase()===c&&c.toUpperCase()!==c){this.hideCapsIcon()}}}},onInputChange:function(){if(this.$currentInput.val()){this.$showPasswordToggle.show()}else{this.$showPasswordToggle.hide()}},onToggleMouseDown:function(b){b.preventDefault();if(this.$currentInput[0].setSelectionRange){var c=this.$currentInput[0].selectionStart,d=this.$currentInput[0].selectionEnd}this.togglePassword();if(this.$currentInput[0].setSelectionRange){this.$currentInput[0].setSelectionRange(c,d)}}});a.fn.passwordInput=function(){return this.each(function(){if(!a.data(this,"passwordInput")){new Blocks.ui.PasswordInput(this)}})};Blocks.$document.ready(function(){a("input.password").passwordInput()})})(jQuery);(function(b){Blocks.ui.MixedInput=Blocks.Base.extend({$container:null,elements:null,focussedElement:null,blurTimeout:null,init:function(c,d){this.$container=b(c);this.setSettings(d,Blocks.ui.MixedInput.defaults);this.elements=[];this.$container.attr("tabindex",0);this.addListener(this.$container,"focus","onFocus")},getElementIndex:function(c){return b.inArray(c,this.elements)},isText:function(c){return(c.prop("nodeName")=="INPUT")},onFocus:function(d){if(this.elements.length){var c=this.elements[0];this.setFocus(c);this.setCarotPos(c,0)}else{this.addTextElement()}},addTextElement:function(c){var d=new a(this);this.addElement(d.$input,c);return d},addElement:function(c,g){if(typeof g=="undefined"){if(this.focussedElement){var j=this.focussedElement,h=this.getElementIndex(j);if(this.isText(j)){var k=j.prop("selectionStart"),l=j.prop("selectionEnd"),d=j.val(),e=d.substring(0,k),i=d.substr(l);if(e&&i){j.val(e).trigger("change");var f=new a(this);f.$input.val(i).trigger("change");this.addElement(f.$input,h+1);g=h+1}else{if(!e){g=h}else{g=h+1}}}else{g=h+1}}else{g=this.elements.length}}if(typeof this.elements[g]!="undefined"){c.insertBefore(this.elements[g]);this.elements.splice(g,0,c)}else{g=this.elements.length;this.$container.append(c);this.elements.push(c)}if(!this.isText(c)){if(g==0||!this.isText(this.elements[g-1])){this.addTextElement(g);g++}if(g==this.elements.length-1||!this.isText(this.elements[g+1])){this.addTextElement(g+1)}}this.addListener(c,"click",function(){this.setFocus(c)});setTimeout(b.proxy(function(){this.setFocus(c)},this),1)},removeElement:function(c){var e=this.getElementIndex(c);if(e!=-1){this.elements.splice(e,1);if(!this.isText(c)){var h=this.elements[e-1],f=this.elements[e];if(this.isText(h)&&this.isText(f)){var g=h.val(),d=g+f.val();h.val(d).trigger("change");this.removeElement(f);this.setFocus(h);this.setCarotPos(h,g.length)}}c.remove()}},setFocus:function(c){this.$container.addClass("focus");if(!this.focussedElement){this.$container.attr("tabindex","-1")}else{this.blurFocussedElement()}c.attr("tabindex","0");c.focus();this.focussedElement=c;this.addListener(c,"blur",function(){this.blurTimeout=setTimeout(b.proxy(function(){if(this.focussedElement==c){this.blurFocussedElement();this.focussedElement=null;this.$container.removeClass("focus");this.$container.attr("tabindex","0")}},this),1)})},blurFocussedElement:function(){this.removeListener(this.focussedElement,"blur");this.focussedElement.attr("tabindex","-1")},focusPreviousElement:function(f){var d=this.getElementIndex(f);if(d>0){var c=this.elements[d-1];this.setFocus(c);if(this.isText(c)){var e=c.val().length;this.setCarotPos(c,e)}}},focusNextElement:function(e){var d=this.getElementIndex(e);if(d<this.elements.length-1){var c=this.elements[d+1];this.setFocus(c);if(this.isText(c)){this.setCarotPos(c,0)}}},setCarotPos:function(c,d){c.prop("selectionStart",d);c.prop("selectionEnd",d)}});var a=Blocks.Base.extend({parentInput:null,$input:null,$stage:null,val:null,focussed:false,interval:null,init:function(c){this.parentInput=c;this.$input=b('<input type="text"/>').appendTo(this.parentInput.$container);this.$input.css("margin-right",(2-a.padding)+"px");this.setWidth();this.addListener(this.$input,"focus","onFocus");this.addListener(this.$input,"blur","onBlur");this.addListener(this.$input,"keydown","onKeyDown");this.addListener(this.$input,"change","checkInput")},getIndex:function(){return this.parentInput.getElementIndex(this.$input)},buildStage:function(){this.$stage=b("<stage/>").appendTo(Blocks.$body);this.$stage.css({position:"absolute",top:-9999,left:-9999,wordWrap:"nowrap"});Blocks.copyTextStyles(this.$input,this.$stage)},getTextWidth:function(c){if(!this.$stage){this.buildStage()}if(c){c=c.replace(/&/g,"&amp;");c=c.replace(/</g,"&lt;");c=c.replace(/>/g,"&gt;");c=c.replace(/ /g,"&nbsp;")}this.$stage.html(c);this.stageWidth=this.$stage.width();return this.stageWidth},onFocus:function(){this.focussed=true;this.interval=setInterval(b.proxy(this,"checkInput"),Blocks.ui.NiceText.interval);this.checkInput()},onBlur:function(){this.focussed=false;clearInterval(this.interval);this.checkInput()},onKeyDown:function(c){setTimeout(b.proxy(this,"checkInput"),1);switch(c.keyCode){case Blocks.LEFT_KEY:if(this.$input.prop("selectionStart")==0&&this.$input.prop("selectionEnd")==0){this.parentInput.focusPreviousElement(this.$input)}break;case Blocks.RIGHT_KEY:if(this.$input.prop("selectionStart")==this.val.length&&this.$input.prop("selectionEnd")==this.val.length){this.parentInput.focusNextElement(this.$input)}break;case Blocks.DELETE_KEY:if(this.$input.prop("selectionStart")==0&&this.$input.prop("selectionEnd")==0){this.parentInput.focusPreviousElement(this.$input);c.preventDefault()}}},getVal:function(){this.val=this.$input.val();return this.val},setVal:function(c){this.$input.val(c);this.checkInput()},checkInput:function(){var c=(this.val!==this.getVal());if(c){this.setWidth();this.onChange()}return c},setWidth:function(){if(this.stageWidth!==this.getTextWidth(this.val)){var c=this.stageWidth+a.padding;this.$input.width(c)}},onChange:function(){}},{padding:20})})(jQuery);(function(a){Blocks.ui.AdminPane=Blocks.Base.extend({$container:null,$listContainer:null,$list:null,$addBtn:null,$settingsContainer:null,inputName:null,items:null,itemSort:null,selectedItem:null,totalNewItems:0,init:function(b){this.$container=a(b);if(this.$container.data("adminpane")){Blocks.log("Double-instantiating an admin pane on an element");this.$container.data("adminpane").destroy()}this.$container.data("adminpane",this);this.inputName=this.$container.attr("data-input-name");this.$listContainer=this.$container.children(".list:first");this.$list=this.$listContainer.children("ul:first");this.$addBtn=this.$listContainer.children(".btn:first");this.$settingsContainer=this.$container.children(".settings:first");var h=this.$container.children(".freshsettings:first").remove().removeClass("freshsettings");this.freshSettingsHtml=h.html();this.itemSort=new Blocks.ui.DragSort({axis:"y",helper:function(l){var i=a("<ul/>");l.appendTo(i);l.removeClass("sel");return i}});this.items={};var e=this.$list.children("li"),k=this.$settingsContainer.children();for(var d=0;d<e.length;d++){var g=a(e[d]),f=g.attr("data-item-id"),c=k.filter("[data-item-id="+f+"]:first");var j=new Blocks.ui.AdminPane.Item(this,f,g,c);this.items[f]=j;if(j.isNew){this.totalNewItems++}this.itemSort.addItems(g)}this.addListener(this.$addBtn,"click","addItem")},selectItem:function(b){this.items[b].select()},setHeight:function(){var b=Math.max(this.$listContainer.height(),this.$settingsContainer.height());this.$container.height(b+28)},addItem:function(){this.totalNewItems++;var g="new"+(this.totalNewItems),f=this.inputName+"-"+g,b=a('<li class="item" data-settings-id="'+f+'"><div class="name"></div><div class="type"></div><input type="hidden" name="'+this.inputName+'[order][]" value="'+g+'"/></a>').appendTo(this.$list),d=this.freshSettingsHtml.replace(/ITEM_ID/g,g),c=a('<div data-item-id="'+g+'"/>').html(d).appendTo(this.$settingsContainer);var e=new Blocks.ui.AdminPane.Item(this,g,b,c);this.items[g]=e;e.select();this.itemSort.addItems(b);return e}});Blocks.ui.AdminPane.Item=Blocks.Base.extend({adminPane:null,id:null,isNew:null,$item:null,$settings:null,$name:null,$type:null,$doneBtn:null,$deleteBtn:null,init:function(f,e,b,d){this.adminPane=f;this.id=e;this.isNew=(this.id.substr(0,3)=="new");this.$item=b;this.$settings=d;this.$name=b.children(".name:first");this.$type=b.children(".type:first");var c=this.$settings.children(".buttons:first");this.$doneBtn=c.children(".done:first");this.$deleteBtn=c.children(".delete:first");this.addListener(this.$item,"mousedown","select");this.addListener(this.$doneBtn,"click",function(){this.deselect();this.adminPane.setHeight()});this.addListener(this.$deleteBtn,"click","deleteItem")},select:function(){if(this.adminPane.selectedItem){this.adminPane.selectedItem.deselect()}this.adminPane.selectedItem=this;this.$item.addClass("sel");this.$settings.show();this.adminPane.setHeight()},deselect:function(){this.$item.removeClass("sel");this.$settings.hide();this.adminPane.selectedItem=null},setName:function(b){this.$name.html(b)},setType:function(b){this.$type.html(b)},deleteItem:function(){if(confirm(Blocks.t("Are you sure you want to delete {name}?",{name:this.$name.html()}))){this.$item.remove();this.$settings.remove();this.adminPane.setHeight();if(!this.isNew){a('<input type="hidden" name="'+this.adminPane.inputName+'[delete][]" value="'+this.id+'"/>').appendTo(this.adminPane.$container)}this.destroy()}}})})(jQuery);(function(a){Blocks.ui.FieldToggle=Blocks.Base.extend({$toggle:null,reverse:null,targetPrefix:null,_$target:null,type:null,init:function(b){this.$toggle=a(b);if(this.$toggle.data("fieldtoggle")){Blocks.log("Double-instantiating a field toggle on an element");this.$toggle.data("fieldtoggle").destroy()}this.$toggle.data("fieldtoggle",this);this.type=this.getType();this.reverse=!!this.$toggle.attr("data-reverse-toggle");if(this.type=="select"){this.targetPrefix=(this.$toggle.attr("data-target-prefix")||"");this.findTarget()}if(this.type=="link"){this.addListener(this.$toggle,"click","onToggleChange")}else{this.addListener(this.$toggle,"change","onToggleChange")}},getType:function(){if(this.$toggle.prop("nodeName")=="INPUT"&&this.$toggle.attr("type").toLowerCase()=="checkbox"){return"checkbox"}else{if(this.$toggle.prop("nodeName")=="SELECT"){return"select"}else{if(this.$toggle.prop("nodeName")=="A"){return"link"}}}},getTarget:function(){if(!this._$target){this.findTarget()}return this._$target},findTarget:function(){if(this.type=="select"){this._$target=a("#"+this.targetPrefix+this.getToggleVal())}else{this._$target=a("#"+this.$toggle.attr("data-target"))}},getToggleVal:function(){return Blocks.getInputPostVal(this.$toggle)},onToggleChange:function(){if(this.type=="select"){this.hideTarget();this.findTarget();this.showTarget()}else{if(this.type=="link"){var b=this.$toggle.hasClass("collapsed")}else{var b=!!this.getToggleVal()}if(this.reverse){b=!b}if(b){this.showTarget()}else{this.hideTarget()}}},showTarget:function(){if(this.getTarget().length){this.getTarget().removeClass("hidden");if(this.type!="select"){if(this.type=="link"){this.$toggle.removeClass("collapsed");this.$toggle.addClass("expanded")}var c=this.getTarget();c.height("auto");var b=c.height();c.height(0);c.stop().animate({height:b},"fast",a.proxy(function(){c.height("auto")},this))}}},hideTarget:function(){if(this.getTarget().length){if(this.type=="select"){this.getTarget().addClass("hidden")}else{if(this.type=="link"){this.$toggle.removeClass("expanded");this.$toggle.addClass("collapsed")}this.getTarget().stop().animate({height:0},"fast",a.proxy(function(){this.getTarget().addClass("hidden")},this))}}}});a.fn.fieldtoggle=function(){return this.each(function(){if(!a.data(this,"fieldtoggle")){new Blocks.ui.FieldToggle(this)}})};Blocks.$document.ready(function(){a(".fieldtoggle").fieldtoggle()})})(jQuery);(function(a){Blocks.ui.CheckboxSelect=Blocks.Base.extend({$container:null,$all:null,$options:null,init:function(b){this.$container=a(b);if(this.$container.data("checkboxSelect")){Blocks.log("Double-instantiating a checkbox select on an element");this.$container.data("checkbox-select").destroy()}this.$container.data("checkboxSelect",this);var c=this.$container.find("input");this.$all=c.filter(".all:first");this.$options=c.not(this.$all);this.addListener(this.$all,"change","onAllChange")},onAllChange:function(){var b=this.$all.prop("checked");this.$options.attr({checked:b,disabled:b})}});a.fn.checkboxSelect=function(){return this.each(function(){if(!a.data(this,"checkboxSelect")){new Blocks.ui.CheckboxSelect(this)}})};Blocks.$document.ready(function(){a(".checkbox-select").checkboxSelect()})})(jQuery);(function(a){Blocks.ui.LinksBlock=Blocks.Base.extend({_$inputContainer:null,_$inputTbody:null,_$fillerRows:null,_$showModalBtn:null,_$removeLinksBtn:null,_$modalBody:null,_$modalTbody:null,_$cancelBtn:null,_$selectBtn:null,_name:null,_settings:null,_selectedIds:null,_minSlots:null,_modal:null,_inputSelect:null,_modalSelect:null,_inputSort:null,init:function(f,h,b){this._name=f;this._settings=h;this._selectedIds=b;this._$inputContainer=a("#blocks-"+this._name);var e=this._$inputContainer.next();this._$showModalBtn=e.find(".btn.add");this._$removeLinksBtn=e.find(".btn.remove");var d=this._$inputContainer.children("table");this._$inputTbody=d.children("tbody");var c=this._$inputTbody.children(":not(.filler)");var g=c.find("div.entity");this._inputSelect=new Blocks.ui.Select(this._$inputContainer,g,{multi:true,onSelectionChange:a.proxy(function(){if(this._inputSelect.totalSelected){this._$removeLinksBtn.enable()}else{this._$removeLinksBtn.disable()}},this)});this._inputSort=new Blocks.ui.DataTableSorter(d,{handle:".entity",filter:a.proxy(function(){return this._inputSelect.getSelectedItems().closest("tr")},this),onSortChange:a.proxy(function(){this._inputSelect.resetItemOrder()},this)});this._minSlots=h.limit?Math.min(3,h.limit):3;if(g.length<this._minSlots){this._$fillerRows=this._$inputTbody.children(".filler")}this.addListener(this._$showModalBtn,"activate","_showModal");this.addListener(this._$removeLinksBtn,"activate","_removeSelectedEntities")},_buildModal:function(){var e=a('<div class="addlinksmodal modal"/>').appendTo(Blocks.$body),d=a('<header class="header"><h1>'+this._settings.addLabel+"</h1></header>").appendTo(e);this._$modalBody=a('<div class="body"/>').appendTo(e);var c=a('<footer class="footer"/>').appendTo(e),g=a('<ul class="right"/>').appendTo(c),f=a("<li/>").appendTo(g),b=a("<li/>").appendTo(g);this._$cancelBtn=a('<div class="btn">'+Blocks.t("Cancel")+"</div>").appendTo(f);this._$selectBtn=a('<div class="btn submit disabled">'+this._settings.addLabel+"</div>").appendTo(b);this._modal=new Blocks.ui.Modal(e);this._updateModal();this.addListener(this._$cancelBtn,"activate","_hideModal");this.addListener(this._$selectBtn,"activate","_selectEntities")},_showModal:function(){if(!this._modal){this._buildModal()}else{this._inputSelect.deselectAll();this._modalSelect.deselectAll();this._modal.show();setTimeout(a.proxy(function(){this._$modalBody.focus()},this),50)}},_hideModal:function(){this._modal.hide();this._$inputContainer.focus()},_updateModal:function(){var b={type:this._settings.type,name:this._name,settings:this._settings.linkTypeSettings,selectedIds:this._selectedIds};Blocks.postActionRequest("links/getModalBody",b,a.proxy(function(c){this._$modalBody.html(c);this._$modalTbody=this._$modalBody.find("tbody:first");var d=this._$modalTbody.children(":not(.hidden)").find(".entity");this._modalSelect=new Blocks.ui.Select(this._$modalBody,d,{multi:true,waitForDblClick:true,onSelectionChange:a.proxy(function(){if(this._modalSelect.totalSelected){this._$selectBtn.enable()}else{this._$selectBtn.disable()}},this)});this.addListener(this._$modalBody,"dblclick","_selectEntities")},this))},_selectEntities:function(){if(!this._modalSelect.totalSelected){return}var c=this._modalSelect.getSelectedItems();this._modalSelect.removeItems(c);var d=Math.min(c.length,this._$fillerRows.length);this._$fillerRows.slice(0,d).remove();this._$fillerRows=this._$fillerRows.slice(d);var b=c.closest("tr"),e=b.clone();if(this._$fillerRows.length){e.insertBefore(this._$fillerRows.first())}else{e.appendTo(this._$inputTbody)}this._modal.hide();this._$removeLinksBtn.enable();c=e.find(".entity");this._inputSelect.addItems(c);this._inputSort.addItems(e);this._$inputContainer.focus();setTimeout(function(){b.addClass("hidden")},200)},_removeSelectedEntities:function(){if(!this._inputSelect.totalSelected){return}var k=this._inputSelect.getSelectedItems(),h=k.closest("tr");this._inputSelect.removeItems(k);this._inputSort.removeItems(h);h.remove();var g=this._inputSelect.$items.length;var c=this._minSlots-g;for(var f=this._$fillerRows.length;f<c;f++){var e=a('<tr class="filler"><td></td></tr>').appendTo(this._$inputTbody);this._$fillerRows=this._$fillerRows.add(e)}this._$removeLinksBtn.disable();if(this._modal){var b=this._$modalTbody.children(".hidden").find(".entity");for(var f=0;f<k.length;f++){var d=a(k[f]).attr("data-id"),j=b.filter("[data-id="+d+"]:first");j.closest("tr").removeClass("hidden");this._modalSelect.addItems(j)}}this._$inputContainer.focus()}})})(jQuery);(function(a){Blocks.ui.AdminTable=Blocks.Base.extend({settings:null,$table:null,totalObjects:null,sorter:null,init:function(c){this.setSettings(c,Blocks.ui.AdminTable.defaults);this.$table=a(this.settings.tableSelector);this.totalObjects=this.$table.children("tbody").children().length;if(this.settings.sortable){this.sorter=new Blocks.ui.DataTableSorter(this.$table,{onSortChange:a.proxy(this,"reorderObjects")})}var b=this.$table.find(".delete");this.addListener(b,"click","deleteObject")},reorderObjects:function(){if(!this.settings.sortable){return false}var c=[];for(var b=0;b<this.sorter.$items.length;b++){var e=parseInt(a(this.sorter.$items[b]).attr(this.settings.idAttribute));c.push(e)}var d={ids:JSON.stringify(c)};Blocks.postActionRequest(this.settings.reorderAction,d,a.proxy(function(f){if(f.success){Blocks.cp.displayNotice(Blocks.t(this.settings.reorderSuccessMessage))}else{Blocks.cp.displayError(Blocks.t(this.settings.reorderFailMessage))}},this))},deleteObject:function(d){var b=a(d.target).closest("tr"),e=b.attr(this.settings.idAttribute),c=b.attr(this.settings.nameAttribute);if(this.confirmDeleteObject(b)){Blocks.postActionRequest(this.settings.deleteAction,{id:e},a.proxy(function(f){if(f.success){b.remove();this.totalObjects--;if(this.totalObjects==0){this.$table.remove();a(this.settings.noObjectsSelector).removeClass("hidden")}Blocks.cp.displayNotice(Blocks.t(this.settings.deleteSuccessMessage,{name:c}))}else{Blocks.cp.displayError(Blocks.t(this.settings.deleteFailMessage,{name:c}))}},this))}},confirmDeleteObject:function(b){var c=b.attr(this.settings.nameAttribute);return confirm(Blocks.t(this.settings.confirmDeleteMessage,{name:c}))}},{defaults:{tableSelector:null,noObjectsSelector:null,idAttribute:"data-id",nameAttribute:"data-name",sortable:false,reorderAction:null,deleteAction:null,reorderSuccessMessage:"New order saved.",reorderFailMessage:"Couldnt save new order.",confirmDeleteMessage:"Are you sure you want to delete {name}?",deleteSuccessMessage:"{name} deleted.",deleteFailMessage:"Couldnt delete {name}."}})})(jQuery);