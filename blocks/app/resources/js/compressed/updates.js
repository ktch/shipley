/*!
 * Blocks by Pixel & Tonic
 *
 * @package   Blocks
 * @author    Pixel & Tonic, Inc.
 * @copyright Copyright (c) 2012, Pixel & Tonic, Inc.
 * @license   http://blockscms.com/license1.0.html Blocks License
 * @link      http://blockscms.com
 */
(function(c){var a=Blocks.Base.extend({$table:null,$tbody:null,init:function(j,e,g){this.$table=c("<table/>").appendTo(j);this.$tbody=c("<tbody/>").appendTo(this.$table);this.addNoteRows(e[0].notes);for(var f=1;f<e.length;f++){var d=e[f],h=g+" "+d.version;if(d.build){h+=' <span class="light">'+Blocks.t("build {build}",{build:d.build})+"</span>"}c('<tr><th colspan="2">'+h+"</th></tr>").appendTo(this.$tbody);this.addNoteRows(d.notes)}},addNoteRows:function(f){f=f.split(/[\r\n]+/);for(var e=0;e<f.length;e++){var g=f[e],h=c("<tr/>").appendTo(this.$tbody),d=g.match(/\[(\w+)\]\s*(.+)/);if(d){c('<td class="thin"><span class="category '+d[1].toLowerCase()+'">'+Blocks.t(d[1])+"</span></td>").appendTo(h);c("<td>"+d[2]+"</td>").appendTo(h)}else{c('<td colspan="2">'+g+"</td>").appendTo(h)}}}});var b=function(d){for(var e in d){var f=d[e];if(f.releases&&f.releases.length>0){return true}}return false};Blocks.postActionRequest("update/getAvailableUpdates",function(d){c("#loading").fadeOut("fast",function(){if(d.errors&&d.errors.length>0){var v=c("#update-error");v.html(d.errors[0]);v.show()}else{if((d.blocks&&d.blocks.releases)||d.packages){var o=c("#system-updates"),r=o.children("tbody");o.show();if(d.blocks.releases){var x=c("<tr/>").appendTo(r),g=c("<th/>").appendTo(x),j=c('<td class="thin rightalign"/>').appendTo(x);g.html("Blocks "+d.blocks.releases[0].version+' <span class="light">'+Blocks.t("build {build}",{build:d.blocks.releases[0].build})+"</span>"+(d.blocks.criticalUpdateAvailable?'<span class="critical">'+Blocks.t("Critical")+"</span>":""));var w=function(i){i.on("click",function(){var y=Blocks.getActionUrl("update/downloadBlocksUpdate");c("<iframe/>",{src:y}).appendTo(Blocks.$body).hide()})};if(d.blocks.manualUpdateRequired){var s=c('<div class="btn">'+Blocks.t("Download")+"</div>").appendTo(j);w(s)}else{var m=c('<div class="btngroup"/>').appendTo(j),e=c('<a class="btn" href="'+Blocks.getUrl("updates/go/blocks")+'">'+Blocks.t("Update")+"</a>").appendTo(m),h=c('<div class="btn menubtn nolabel"/>').appendTo(m),k=c('<div class="menu" data-align="right"/>').appendTo(m),q=c("<ul/>").appendTo(k),u=c("<li/>").appendTo(q),n=c("<a>"+Blocks.t("Download")+"</a>").appendTo(u);new Blocks.ui.MenuBtn(h);w(n)}var x=c("<tr/>").appendTo(r),j=c('<td class="notes" colspan="2"/>').appendTo(x);new a(j,d.blocks.releases,"Blocks")}if(d.packages){var x=c("<tr/>").appendTo(r),g=c("<th/>").appendTo(x),j=c('<td class="thin rightalign"/>').appendTo(x),s=c('<a class="btn" href="'+Blocks.getUrl("updates/go/blocks")+'">'+Blocks.t("Install")+"</a>").appendTo(j);var p={packages:d.packages.join(", ")};g.html(d.packages.length>1?Blocks.t("{packages} upgrades",p):Blocks.t("{packages} upgrade",p));if(d.blocks){s.addClass("disabled");s.attr("title",Blocks.t("Blocks update required"))}}}else{c("#no-system-updates").show()}if(d.plugins&&b(d.plugins)){var o=c("#plugin-updates"),r=o.children("tbody");o.show();for(var t in d.plugins){var f=d.plugins[t];if(f.releases&&f.releases.length>0){var x=c("<tr/>").appendTo(r),g=c("<th/>").appendTo(x),j=c('<td class="thin rightalign"/>').appendTo(x);g.html(f.displayName+" "+f.releases[0].version);j.html('<a class="btn" href="'+Blocks.getUrl("updates/"+f["class"].toLowerCase())+'">'+Blocks.t("Update")+"</a>");var x=c("<tr/>").appendTo(r),j=c('<td class="notes" colspan="2"/>').appendTo(x);new a(j,f.releases,f.displayName)}}}else{c("#no-plugin-updates").show()}c("#updates").fadeIn("fast");var l=0;if(d.blocks&&d.blocks.releases){l++}if(d.packages){l++}if(b(d.plugins)){l++}if(l>2){c("#update-all").fadeIn("fast")}}})})})(jQuery);